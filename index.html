<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penjadwalan Pelajaran 
          (Schedulia)</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Third-party libraries for features -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <style>
        /* Custom styles */
        :root {
            --bg-color: #f0f4f8;
            --text-color: #1f2937;
            --card-bg: white;
            --sidebar-bg: #1f2937;
            --sidebar-text: #e5e7eb;
            --header-bg: white;
            --border-color: #e5e7eb;
        }
        html.dark {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --sidebar-bg: #111827;
            --sidebar-text: #9ca3af;
            --header-bg: #1f2937;
            --border-color: #374151;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #app-view, #login-view, #register-view {
             transition: background-color 0.3s, color 0.3s;
        }
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            transform: translateX(5px);
        }
        .stat-card, .bg-white, .fc-view, .fc-toolbar, .fc-col-header, .fc-daygrid-day, .fc-list-day-cushion, .fc-list-table, .fc-list-event:hover td {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        #sidebar {
             background-color: var(--sidebar-bg);
             color: var(--sidebar-text);
        }
        header {
             background-color: var(--header-bg);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
             background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* For modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            transition: opacity 0.3s ease;
        }
       .skip-link {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateY(-120%);
            transition: transform 0.3s;
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            z-index: 1000;
            border-radius: 0 0 8px 8px;
        }

        .skip-link:focus {
            transform: translateY(0%);
        }

        /* --- Custom Calendar Styles --- */
        .fc {
            font-family: 'Poppins', sans-serif;
        }
        .fc .fc-toolbar-title {
            font-size: 1.6rem !important;
            font-weight: 600;
            color: var(--text-color);
        }
        .fc .fc-button-primary {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
            transition: background-color 0.2s;
        }
        html.dark .fc .fc-button-primary {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
        }
        .fc .fc-button-primary:hover {
            background-color: #2563eb !important;
        }
        html.dark .fc .fc-button-primary:hover {
            background-color: #1d4ed8 !important;
        }
        .fc .fc-day-today {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        html.dark .fc .fc-day-today {
            background-color: rgba(59, 130, 246, 0.2) !important;
        }
        .fc-event {
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 8px !important;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 0.8em !important;
            color: white !important;
        }
        .fc-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .fc-event .fc-event-main {
            overflow: hidden;
        }
        .fc-event-title {
            font-weight: 600 !important;
        }
        .fc-v-event .fc-event-main-frame {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .special-event-row {
            background-color: #f3f4f6;
        }
        html.dark .special-event-row {
            background-color: #374151;
        }
        /* Tab styles */
        .tab-btn {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        html.dark .tab-btn.active {
             border-bottom-color: #60a5fa;
             color: #60a5fa;
        }


    </style>
</head>
<body class="antialiased">
    <a href="#main-content" class="skip-link">Lewati ke konten</a>

    <!-- Main Application Container -->
    <div id="app">

        <!-- LOGIN VIEW -->
        <div id="login-view" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-indigo-600">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-2xl">
                <div class="text-center space-y-4">
                    <div class="flex items-center justify-center gap-3">
                        <i class="fas fa-calendar-alt text-5xl text-blue-500"></i>
                        <h2 class="text-5xl font-bold text-gray-900 tracking-tight">Schedulia</h2>
                    </div>
                    <p class="text-gray-600">Penjadwalan Pelajaran Kelas Cerdas</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="text-sm font-semibold text-gray-700">Username</label>
                        <input type="text" id="username" name="username" placeholder="Masukkan username" required class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-semibold text-gray-700">Password</label>
                        <input type="password" id="password" name="password" placeholder="Masukkan password" required class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="login-error" class="text-sm text-red-500 text-center hidden"></p>
                    <div>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300">
                            Login
                        </button>
                    </div>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Belum punya akun? 
                    <a href="#" id="show-register-view" class="font-medium text-blue-600 hover:text-blue-500">
                        Daftar di sini
                    </a>
                </p>
            </div>
        </div>
        
        <!-- REGISTER VIEW -->
        <div id="register-view" class="hidden items-center justify-center min-h-screen bg-gradient-to-br from-green-400 to-teal-600 py-12">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-2xl">
                <div class="text-center">
                    <i class="fas fa-user-plus text-5xl text-green-500"></i>
                    <h2 class="mt-4 text-3xl font-bold text-gray-900">Buat Akun Baru</h2>
                    <p class="mt-1 text-gray-600">Daftar untuk Schedulia</p>
                </div>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="reg-username" class="text-sm font-semibold text-gray-700">Username</label>
                        <input type="text" id="reg-username" name="username" placeholder="Buat username unik" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label for="reg-password" class="text-sm font-semibold text-gray-700">Password</label>
                        <input type="password" id="reg-password" name="password" placeholder="Buat password" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                     <div>
                        <label for="reg-nama" class="text-sm font-semibold text-gray-700">Nama Lengkap</label>
                        <input type="text" id="reg-nama" name="nama" placeholder="Masukkan nama lengkap" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                         <label for="reg-role" class="text-sm font-semibold text-gray-700">Daftar sebagai</label>
                         <select id="reg-role" name="role" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                             <option value="siswa">Siswa</option>
                             <option value="guru">Guru</option>
                         </select>
                    </div>
    
                    <!-- Conditional fields for Siswa -->
                    <div id="siswa-fields">
                         <div>
                            <label for="reg-nis" class="text-sm font-semibold text-gray-700">NIS</label>
                            <input type="text" id="reg-nis" name="nis" placeholder="Nomor Induk Siswa" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="mt-4">
                             <label for="reg-kelas" class="text-sm font-semibold text-gray-700">Kelas</label>
                             <select id="reg-kelas" name="kelas_id" required class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <!-- Options will be populated by JS -->
                             </select>
                        </div>
                    </div>
    
                    <!-- Conditional fields for Guru -->
                    <div id="guru-fields" class="hidden">
                        <div>
                            <label for="reg-mapel" class="text-sm font-semibold text-gray-700">Mata Pelajaran Utama</label>
                            <input type="text" id="reg-mapel" name="mapel" placeholder="Contoh: Matematika" class="w-full px-4 py-2 mt-1 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    
                    <p id="register-error" class="text-sm text-red-500 text-center hidden"></p>
                    <p id="register-success" class="text-sm text-green-500 text-center hidden"></p>
    
                    <div>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300">
                            Daftar
                        </button>
                    </div>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Sudah punya akun? 
                    <a href="#" id="show-login-view" class="font-medium text-green-600 hover:text-green-500">
                        Login di sini
                    </a>
                </p>
            </div>
        </div>

        <!-- MAIN APP VIEW (Hidden by default) -->
        <div id="app-view" class="hidden">
            <div class="flex h-screen">
                <!-- Sidebar -->
                <aside id="sidebar" class="w-64 flex flex-col">
                    <div class="p-4 flex items-center justify-center gap-3 border-b border-gray-700">
                       <i class="fas fa-calendar-alt text-2xl text-blue-500"></i>
                       <h1 class="text-2xl font-bold">Schedulia</h1>
                    </div>
                    <nav id="sidebar-nav" class="flex-1 p-4 space-y-2">
                        <!-- Navigation links will be inserted here by JavaScript -->
                    </nav>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col">
                    <!-- Header -->
                    <header class="flex items-center justify-between p-4 shadow-md z-10">
                        <div>
                           <h2 class="text-xl font-semibold">Selamat Datang, <span id="user-name"></span>!</h2>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                <i class="fas fa-moon text-xl"></i>
                            </button>
                            <button id="notification-btn" class="relative p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notification-dot" class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full hidden"></span>
                            </button>
                            <button id="logout-btn" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </header>

                    <!-- Page Content -->
                    <main id="main-content" class="flex-1 p-6 overflow-y-auto" tabindex="-1">
                        <!-- Content will be dynamically inserted here -->
                    </main>
                </div>
            </div>
        </div>
        
        <!-- Modal for Admin Forms and Notifications -->
        <div id="admin-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
            <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-gray-600">
                    <h3 id="modal-title" class="text-xl font-semibold">Modal Title</h3>
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
                </div>
                <div id="modal-body">
                    <!-- Form content will be injected here -->
                </div>
            </div>
        </div>
        
    </div>

    <!-- JavaScript Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- MOCK DATABASE ---
        const db = {
            users: [
                { id: 1, username: 'admin', password: '123', role: 'admin', approved: true },
                { id: 2, username: 'budi', password: '123', role: 'siswa', detail_id: 101, approved: true },
                { id: 3, username: 'citra', password: '123', role: 'siswa', detail_id: 102, approved: true },
                { id: 4, username: 'dono', password: '123', role: 'siswa', detail_id: 103, approved: true },
                { id: 5, username: 'eko', password: '123', role: 'guru', detail_id: 202, approved: true },
                { id: 6, username: 'admin2', password: '123', role: 'admin', approved: true },
                { id: 7, username: 'putri', password: '123', role: 'siswa', detail_id: 104, approved: true },
                { id: 8, username: 'retno', password: '123', role: 'guru', detail_id: 201, approved: true },
            ],
            gurus: [
                { id: 201, nama: 'Ibu Retno', mapel: 'Matematika' },
                { id: 202, nama: 'Bapak Eko', mapel: 'Fisika' },
                { id: 203, nama: 'Ibu Wati', mapel: 'Bahasa Indonesia' },
                { id: 204, nama: 'Bapak Agus', mapel: 'Sejarah' },
            ],
            siswas: [
                { id: 101, nama: 'Budi Santoso', kelas_id: 1, nis: 'S001' },
                { id: 102, nama: 'Citra Lestari', kelas_id: 1, nis: 'S002' },
                { id: 103, nama: 'Dono Wijoyo', kelas_id: 2, nis: 'S003' },
                { id: 104, nama: 'Putri Kenanga', kelas_id: 2, nis: 'S004' },
            ],
            kelas: [
                { id: 1, nama: '10-A' },
                { id: 2, nama: '10-B' },
                { id: 3, nama: '11-A' },
            ],
            mapels: [
                { id: 301, nama: 'Matematika' },
                { id: 302, nama: 'Fisika' },
                { id: 303, nama: 'Bahasa Indonesia' },
                { id: 304, nama: 'Sejarah' },
                { id: 305, nama: 'Kimia' },
            ],
            ruangans: [
                { id: 501, nama: 'Lab Fisika' },
                { id: 502, nama: 'Ruang 101' },
                { id: 503, nama: 'Ruang 102' },
            ],
            jadwals: [
                // Jadwal Kelas 10-A (ID 1)
                { id: 1, kelas_id: 1, mapel_id: 301, guru_id: 201, hari: 'Senin', jam_mulai: '07:15', jam_selesai: '08:30', ruangan_id: 502 },
                { id: 2, kelas_id: 1, mapel_id: 303, guru_id: 203, hari: 'Senin', jam_mulai: '08:30', jam_selesai: '10:00', ruangan_id: 502 },
                { id: 3, kelas_id: 1, mapel_id: 302, guru_id: 202, hari: 'Selasa', jam_mulai: '07:15', jam_selesai: '09:00', ruangan_id: 501 },
                // Jadwal Kelas 10-B (ID 2)
                { id: 4, kelas_id: 2, mapel_id: 304, guru_id: 204, hari: 'Senin', jam_mulai: '07:15', jam_selesai: '08:30', ruangan_id: 503 },
                { id: 5, kelas_id: 2, mapel_id: 301, guru_id: 201, hari: 'Rabu', jam_mulai: '10:30', jam_selesai: '12:00', ruangan_id: 503 },
                // Penambahan jadwal baru untuk melengkapi jam belajar
                { id: 6, kelas_id: 1, mapel_id: 304, guru_id: 204, hari: 'Senin', jam_mulai: '10:30', jam_selesai: '12:00', ruangan_id: 502 },
                { id: 7, kelas_id: 1, mapel_id: 302, guru_id: 202, hari: 'Senin', jam_mulai: '12:45', jam_selesai: '14:15', ruangan_id: 501 },
                { id: 8, kelas_id: 1, mapel_id: 303, guru_id: 203, hari: 'Selasa', jam_mulai: '09:00', jam_selesai: '10:00', ruangan_id: 502 },
                { id: 9, kelas_id: 1, mapel_id: 301, guru_id: 201, hari: 'Selasa', jam_mulai: '10:30', jam_selesai: '12:00', ruangan_id: 502 },
                { id: 10, kelas_id: 1, mapel_id: 304, guru_id: 204, hari: 'Rabu', jam_mulai: '07:15', jam_selesai: '09:00', ruangan_id: 502 },
                { id: 11, kelas_id: 1, mapel_id: 305, guru_id: 202, hari: 'Rabu', jam_mulai: '09:00', jam_selesai: '10:00', ruangan_id: 502 },
                { id: 12, kelas_id: 2, mapel_id: 303, guru_id: 203, hari: 'Selasa', jam_mulai: '08:00', jam_selesai: '10:00', ruangan_id: 503 },
                { id: 13, kelas_id: 2, mapel_id: 302, guru_id: 202, hari: 'Rabu', jam_mulai: '07:15', jam_selesai: '09:00', ruangan_id: 501 }
            ],
            acaraSekolah: [
                { id: 901, nama: 'Istirahat', jam_mulai: '10:00', jam_selesai: '10:30', type: 'break' },
                { id: 902, nama: 'Sholat Dzuhur', jam_mulai: '12:00', jam_selesai: '12:45', type: 'prayer' },
                { id: 903, nama: 'Jam Masuk', jam_mulai: '07:00', jam_selesai: '07:15', type: 'school_time' },
                { id: 904, nama: 'Jam Pulang', jam_mulai: '15:00', jam_selesai: '15:15', type: 'school_time' },
            ],
            materis: [
                { id: 1, mapel_id: 301, judul: 'Bab 1 - Aljabar Linear', link: '#' },
                { id: 2, mapel_id: 301, judul: 'Bab 2 - Trigonometri', link: '#' },
                { id: 3, mapel_id: 302, judul: 'Materi Kinematika Gerak Lurus', link: '#' },
                { id: 4, mapel_id: 303, judul: 'Kumpulan Puisi Chairil Anwar', link: '#' },
            ],
            pengumumans: [
                { id: 1, tanggal: '2024-05-20', judul: 'Rapat Guru', isi: 'Diadakan rapat guru wajib pada hari Selasa, 21 Mei 2024 pukul 14:00.', read: false },
            ],
            kehadiran: [
                { id: 1, siswa_id: 101, jadwal_id: 1, status: 'hadir', tanggal: '2024-05-20' },
                { id: 2, siswa_id: 102, jadwal_id: 1, status: 'hadir', tanggal: '2024-05-20' },
                { id: 3, siswa_id: 101, jadwal_id: 2, status: 'izin', tanggal: '2024-05-20' }
            ],
            logs: []
        };

        // --- APPLICATION STATE ---
        let state = {
            currentUser: null,
            currentView: '',
            calendar: null,
        };

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameEl = document.getElementById('user-name');
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');
        const modal = document.getElementById('admin-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationDot = document.getElementById('notification-dot');
        const themeToggle = document.getElementById('theme-toggle');
        const registerView = document.getElementById('register-view');
        const registerForm = document.getElementById('register-form');
        const showRegisterViewBtn = document.getElementById('show-register-view');
        const showLoginViewBtn = document.getElementById('show-login-view');

        // --- THEME LOGIC ---
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun text-xl"></i>' : '<i class="fas fa-moon text-xl"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Re-render view to apply calendar theme
            if (state.currentView === 'admin-kalender' && state.calendar) {
                 state.calendar.destroy(); // Destroy and re-render for theme change
                 renderKalender();
            }
        });
        
        // Check for saved theme
        if (localStorage.getItem('theme') === 'dark' || (localStorage.getItem('theme') !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggle.innerHTML = '<i class="fas fa-sun text-xl"></i>';
        }

        // --- VIEW SWITCHING (Login/Register) ---
        showRegisterViewBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.remove('flex');
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
            registerView.classList.add('flex');
            populateKelasOptions();
        });

        showLoginViewBtn.addEventListener('click', (e) => {
            e.preventDefault();
            registerView.classList.remove('flex');
            registerView.classList.add('hidden');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
        });
        
        // --- LOG ACTIVITY HELPER ---
        function logActivity(action, username) {
            const newLog = {
                id: (db.logs.length > 0 ? Math.max(...db.logs.map(l => l.id)) : 0) + 1,
                timestamp: new Date(),
                user: username,
                action: action
            };
            db.logs.push(newLog);
        }

        // --- LOGIN/LOGOUT/REGISTER LOGIC ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const errorEl = document.getElementById('login-error');
            const user = db.users.find(u => u.username === username && u.password === password);

            if (user) {
                if (!user.approved) {
                    errorEl.textContent = 'Akun Anda belum disetujui oleh admin.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                errorEl.classList.add('hidden');
                logActivity('login', user.username);
                state.currentUser = user;
                 if (user.role === 'siswa') {
                    state.currentUser.details = db.siswas.find(s => s.id === user.detail_id);
                } else if (user.role === 'guru') {
                    state.currentUser.details = db.gurus.find(g => g.id === user.detail_id);
                }
                initApp();
            } else {
                 errorEl.textContent = 'Username atau password salah!';
                 errorEl.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => {
            logActivity('logout', state.currentUser.username);
            state.currentUser = null;
            state.currentView = '';
            appView.classList.add('hidden');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
        });
        
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('register-error');
            const successEl = document.getElementById('register-success');
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Check if username exists
            if (db.users.find(u => u.username === data.username)) {
                errorEl.textContent = 'Username sudah digunakan. Silakan pilih yang lain.';
                errorEl.classList.remove('hidden');
                return;
            }

            // Create new user
            const newUserId = (db.users.length > 0 ? Math.max(...db.users.map(u => u.id)) : 0) + 1;
            let newDetailId;

            if (data.role === 'siswa') {
                newDetailId = (db.siswas.length > 0 ? Math.max(...db.siswas.map(s => s.id)) : 0) + 1;
                db.siswas.push({ id: newDetailId, nama: data.nama, kelas_id: parseInt(data.kelas_id), nis: data.nis });
            } else { // guru
                newDetailId = (db.gurus.length > 0 ? Math.max(...db.gurus.map(g => g.id)) : 0) + 1;
                db.gurus.push({ id: newDetailId, nama: data.nama, mapel: data.mapel });
            }

            db.users.push({
                id: newUserId,
                username: data.username,
                password: data.password,
                role: data.role,
                detail_id: newDetailId,
                approved: true // Set status to approved directly
            });
            
            logActivity('daftar', data.username);

            successEl.textContent = 'Pendaftaran berhasil! Silakan login.';
            successEl.classList.remove('hidden');
            
            setTimeout(() => {
                registerForm.reset();
                document.getElementById('reg-role').dispatchEvent(new Event('change'));
                showLoginViewBtn.click();
                successEl.classList.add('hidden');
                errorEl.classList.add('hidden');
            }, 2000);
        });
        
        // Show/hide conditional fields on role change in register form
        document.getElementById('reg-role').addEventListener('change', (e) => {
            const role = e.target.value;
            const siswaFields = document.getElementById('siswa-fields');
            const guruFields = document.getElementById('guru-fields');
            const nisInput = document.getElementById('reg-nis');
            const kelasSelect = document.getElementById('reg-kelas');
            const mapelInput = document.getElementById('reg-mapel');

            if (role === 'siswa') {
                siswaFields.classList.remove('hidden');
                guruFields.classList.add('hidden');
                nisInput.required = true;
                kelasSelect.required = true;
                mapelInput.required = false;
            } else { // guru
                siswaFields.classList.add('hidden');
                guruFields.classList.remove('hidden');
                nisInput.required = false;
                kelasSelect.required = false;
                mapelInput.required = true;
            }
        });

        function populateKelasOptions() {
            const kelasSelect = document.getElementById('reg-kelas');
            if(kelasSelect) {
                kelasSelect.innerHTML = db.kelas.map(k => `<option value="${k.id}">${k.nama}</option>`).join('');
            }
        }
        
        // --- PRAYER TIME ---
        async function fetchAndUpdatePrayerTime() {
            const date = new Date();
            const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
            // Coordinates for Dramaga, West Java
            const latitude = -6.55;
            const longitude = 106.73;
            const method = 4; // Kemenag

            try {
                const response = await fetch(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${latitude}&longitude=${longitude}&method=${method}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const dhuhrTime = data.data.timings.Dhuhr;
                    const prayerEvent = db.acaraSekolah.find(a => a.nama === 'Sholat Dzuhur');
                    if (prayerEvent) {
                        // Set start time and add 45 minutes for end time
                        const [hours, minutes] = dhuhrTime.split(':');
                        const startTime = new Date();
                        startTime.setHours(hours, minutes, 0, 0);

                        const endTime = new Date(startTime.getTime() + 45 * 60000);

                        prayerEvent.jam_mulai = startTime.toTimeString().substring(0, 5);
                        prayerEvent.jam_selesai = endTime.toTimeString().substring(0, 5);
                        console.log(`Waktu Sholat Dzuhur diperbarui: ${prayerEvent.jam_mulai} - ${prayerEvent.jam_selesai}`);
                    }
                }
            } catch (error) {
                console.error('Gagal mengambil waktu sholat:', error);
            }
        }


        // --- APP INITIALIZATION ---
        function initApp() {
            fetchAndUpdatePrayerTime(); // Fetch prayer time on app start

            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            registerView.classList.add('hidden');
            registerView.classList.remove('flex');

            appView.classList.remove('hidden');
            const userDetails = state.currentUser.details || { nama: `Admin (${state.currentUser.username})` };
            userNameEl.textContent = userDetails.nama;
            setupSidebar();
            setupNotifications();
            const role = state.currentUser.role;
            if (role === 'admin') renderView('admin-dashboard');
            else if (role === 'siswa') renderView('siswa-dashboard');
            else if (role === 'guru') renderView('guru-dashboard');
        }
        
        // --- SIDEBAR AND NAVIGATION ---
        function setupSidebar() {
            const role = state.currentUser.role;
            let navLinks = '';
            if (role === 'admin') {
                navLinks = `
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-dashboard"><i class="fas fa-tachometer-alt w-6"></i> Dashboard</a>
                    <div class="text-gray-400 text-sm font-semibold mt-4 mb-2 px-3">MANAJEMEN</div>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-jadwal"><i class="fas fa-calendar-plus w-6"></i> Kelola Jadwal</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-pengguna"><i class="fas fa-users-cog w-6"></i> Kelola Data Sekolah</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-materi"><i class="fas fa-book-medical w-6"></i> Kelola Materi</a>
                    <div class="text-gray-400 text-sm font-semibold mt-4 mb-2 px-3">FITUR</div>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-kalender"><i class="fas fa-calendar-week w-6"></i> Tampilan Kalender</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-pengumuman"><i class="fas fa-bullhorn w-6"></i> Kirim Pengumuman</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="admin-logs"><i class="fas fa-history w-6"></i> Log Aktivitas</a>
                `;
            } else if (role === 'guru') {
                navLinks = `
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="guru-dashboard"><i class="fas fa-tachometer-alt w-6"></i> Dashboard</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="guru-jadwal"><i class="fas fa-calendar-day w-6"></i> Jadwal Mengajar</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="guru-kehadiran"><i class="fas fa-check-square w-6"></i> Pencatatan Kehadiran</a>
                `;
            } else { // Siswa
                 navLinks = `
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="siswa-dashboard"><i class="fas fa-tachometer-alt w-6"></i> Dashboard</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="siswa-jadwal"><i class="fas fa-calendar-alt w-6"></i> Jadwal Lengkap</a>
                    <a href="#" class="sidebar-link block p-3 rounded-lg" data-view="siswa-materi"><i class="fas fa-book w-6"></i> Materi Pelajaran</a>
                `;
            }
            sidebarNav.innerHTML = navLinks;
            sidebarNav.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderView(e.currentTarget.dataset.view);
                });
            });
        }
        
        function updateActiveSidebar(view) {
             sidebarNav.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === view);
            });
        }

        // --- MAIN RENDER FUNCTION ---
        function renderView(view) {
            state.currentView = view;
            updateActiveSidebar(view);
            mainContent.innerHTML = ''; 
            const views = {
                'siswa-dashboard': renderSiswaDashboard,
                'siswa-jadwal': () => renderJadwalLengkap({ role: 'siswa' }),
                'siswa-materi': renderSiswaMateri,
                'guru-dashboard': renderGuruDashboard,
                'guru-jadwal': () => renderJadwalLengkap({ role: 'guru' }),
                'guru-kehadiran': renderGuruKehadiran,
                'admin-dashboard': renderAdminDashboard,
                'admin-jadwal': renderAdminJadwal,
                'admin-kalender': renderKalender,
                'admin-logs': renderAdminLogs,
                'admin-pengguna': renderAdminPengguna,
                'admin-materi': () => mainContent.innerHTML = '<h2>Kelola Materi (Soon)</h2>',
                'admin-pengumuman': () => mainContent.innerHTML = '<h2>Kirim Pengumuman (Soon)</h2>',
            };
            if (views[view]) views[view]();
        }
        
        // Helper Functions
        const getMapelName = (id) => db.mapels.find(m => m.id === id)?.nama || 'N/A';
        const getGuruName = (id) => db.gurus.find(g => g.id === id)?.nama || 'N/A';
        const getKelasName = (id) => db.kelas.find(k => k.id === id)?.nama || 'N/A';
        const getRuanganName = (id) => db.ruangans.find(r => r.id === id)?.nama || 'N/A';
        
        // --- DASHBOARD VIEWS ---
        function renderSiswaDashboard() {
            const siswa = state.currentUser.details;
            const kelas = db.kelas.find(k => k.id === siswa.kelas_id);
            const jadwalHariIni = db.jadwals
                .filter(j => j.kelas_id === siswa.kelas_id && j.hari === new Date().toLocaleDateString('id-ID', { weekday: 'long' }))
                .sort((a,b) => a.jam_mulai.localeCompare(b.jam_mulai));
            
            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Dashboard Siswa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-xl mb-4">Informasi Siswa</h3>
                        <p><strong>Nama:</strong> ${siswa.nama}</p>
                        <p><strong>NIS:</strong> ${siswa.nis}</p>
                        <p><strong>Kelas:</strong> ${kelas.nama}</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                         <h3 class="font-semibold text-xl mb-4">Jadwal Hari Ini (${new Date().toLocaleDateString('id-ID', { weekday: 'long' })})</h3>
                         ${jadwalHariIni.length > 0 ? `
                            <ul class="space-y-2">
                            ${jadwalHariIni.map(j => `
                                <li class="p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                    <strong>${j.jam_mulai}-${j.jam_selesai}</strong>: ${getMapelName(j.mapel_id)} (${getGuruName(j.guru_id)})
                                </li>
                            `).join('')}
                            </ul>
                         ` : '<p>Tidak ada jadwal hari ini.</p>'}
                    </div>
                </div>
            `;
        }

        function renderGuruDashboard() {
            const guru = state.currentUser.details;
            const jadwalHariIni = db.jadwals
                .filter(j => j.guru_id === guru.id && j.hari === new Date().toLocaleDateString('id-ID', { weekday: 'long' }))
                .sort((a, b) => a.jam_mulai.localeCompare(b.jam_mulai));

            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Dashboard Guru</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-xl mb-4">Informasi Guru</h3>
                        <p><strong>Nama:</strong> ${guru.nama}</p>
                        <p><strong>Mata Pelajaran:</strong> ${guru.mapel}</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                         <h3 class="font-semibold text-xl mb-4">Jadwal Mengajar Hari Ini</h3>
                         ${jadwalHariIni.length > 0 ? `
                            <ul class="space-y-2">
                            ${jadwalHariIni.map(j => `
                                <li class="p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                    <strong>${j.jam_mulai}-${j.jam_selesai}</strong>: ${getMapelName(j.mapel_id)} (Kelas ${getKelasName(j.kelas_id)})
                                </li>
                            `).join('')}
                            </ul>
                         ` : '<p>Tidak ada jadwal mengajar hari ini.</p>'}
                    </div>
                </div>
            `;
        }

        function renderAdminDashboard() {
            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Dashboard Admin</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card p-6 rounded-lg shadow-lg flex items-center space-x-4">
                        <i class="fas fa-users text-3xl text-blue-500"></i>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Total Siswa</p>
                            <p class="text-2xl font-bold">${db.siswas.length}</p>
                        </div>
                    </div>
                     <div class="stat-card p-6 rounded-lg shadow-lg flex items-center space-x-4">
                        <i class="fas fa-chalkboard-teacher text-3xl text-green-500"></i>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Total Guru</p>
                            <p class="text-2xl font-bold">${db.gurus.length}</p>
                        </div>
                    </div>
                     <div class="stat-card p-6 rounded-lg shadow-lg flex items-center space-x-4">
                        <i class="fas fa-school text-3xl text-yellow-500"></i>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Total Kelas</p>
                            <p class="text-2xl font-bold">${db.kelas.length}</p>
                        </div>
                    </div>
                     <div class="stat-card p-6 rounded-lg shadow-lg flex items-center space-x-4">
                        <i class="fas fa-calendar-alt text-3xl text-red-500"></i>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Total Jadwal</p>
                            <p class="text-2xl font-bold">${db.jadwals.length}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- OTHER VIEWS ---
        function renderSiswaMateri() {
             mainContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Materi Pelajaran</h2>
                <div class="space-y-4">
                ${db.mapels.map(mapel => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-lg">${mapel.nama}</h3>
                        <ul class="mt-2 list-disc list-inside">
                            ${db.materis.filter(m => m.mapel_id === mapel.id).map(materi => `
                                <li><a href="${materi.link}" class="text-blue-500 hover:underline">${materi.judul}</a></li>
                            `).join('') || '<li class="text-gray-500">Belum ada materi.</li>'}
                        </ul>
                    </div>
                `).join('')}
                </div>
             `;
        }

        function renderJadwalLengkap({ role }) {
            let jadwalData;
            let title;

            if (role === 'siswa') {
                const siswa = state.currentUser.details;
                jadwalData = db.jadwals.filter(j => j.kelas_id === siswa.kelas_id);
                title = `Jadwal Lengkap Kelas ${getKelasName(siswa.kelas_id)}`;
            } else { // guru
                const guru = state.currentUser.details;
                jadwalData = db.jadwals.filter(j => j.guru_id === guru.id);
                title = `Jadwal Mengajar ${guru.nama}`;
            }

            const dayOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
            let tableHTML = `<div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold">${title}</h2>
                                <div>
                                    <button id="export-pdf" class="bg-red-500 text-white px-4 py-2 rounded-lg mr-2 hover:bg-red-600 transition-colors"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                                    <button id="export-excel" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"><i class="fas fa-file-excel mr-2"></i>Export Excel</button>
                                </div>
                             </div>
                             <div class="space-y-8">`;
            
            dayOrder.forEach(hari => {
                const jadwalHari = jadwalData.filter(j => j.hari === hari);
                const acaraHariIni = [...jadwalHari, ...db.acaraSekolah].sort((a,b) => a.jam_mulai.localeCompare(b.jam_mulai));
                
                if (acaraHariIni.length > 0) {
                    tableHTML += `
                        <div>
                            <h3 class="text-2xl font-semibold mb-3 border-b-2 border-blue-500 pb-2">${hari}</h3>
                            <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                                <table class="min-w-full text-left">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="p-4">Waktu</th>
                                            <th class="p-4">Kegiatan</th>
                                            <th class="p-4">${role === 'siswa' ? 'Guru' : 'Kelas'}</th>
                                            <th class="p-4">Ruangan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${acaraHariIni.map(j => {
                                            if (j.type) {
                                                const icons = {
                                                    break: 'fa-coffee',
                                                    prayer: 'fa-mosque',
                                                    school_time: 'fa-school'
                                                };
                                                return `
                                                <tr class="border-t dark:border-gray-600 special-event-row font-medium">
                                                    <td class="p-4">${j.jam_mulai} - ${j.jam_selesai}</td>
                                                    <td class="p-4"><i class="fas ${icons[j.type]} mr-2"></i>${j.nama}</td>
                                                    <td class="p-4">-</td>
                                                    <td class="p-4">-</td>
                                                </tr>
                                                `;
                                            }
                                            return `
                                            <tr class="border-t dark:border-gray-600">
                                                <td class="p-4">${j.jam_mulai} - ${j.jam_selesai}</td>
                                                <td class="p-4">${getMapelName(j.mapel_id)}</td>
                                                <td class="p-4">${role === 'siswa' ? getGuruName(j.guru_id) : getKelasName(j.kelas_id)}</td>
                                                <td class="p-4">${getRuanganName(j.ruangan_id)}</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });

            tableHTML += '</div>';
            mainContent.innerHTML = tableHTML;
            document.getElementById('export-pdf').addEventListener('click', () => exportJadwal('pdf', title, jadwalData, role));
            document.getElementById('export-excel').addEventListener('click', () => exportJadwal('excel', title, jadwalData, role));
        }
        
        function renderGuruKehadiran() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold mb-6">Pencatatan Kehadiran</h2>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <p>Fitur pencatatan kehadiran sedang dalam pengembangan. Guru akan dapat menandai kehadiran siswa di sini.</p>
            </div>`;
        }
        
        // --- ADMIN FEATURES ---
        
        // --- ADMIN: Kelola Jadwal ---
        function renderAdminJadwal() {
             mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Kelola Jadwal Pelajaran</h2>
                    <div>
                         <button id="add-jadwal-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                         </button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                     <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${['Hari', 'Waktu', 'Kelas', 'Mapel', 'Guru', 'Ruangan', 'Aksi'].map(h => `<th class="p-4">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="jadwal-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
             `;
             
             displayJadwalTable();

             document.getElementById('add-jadwal-btn').addEventListener('click', () => {
                 openJadwalForm();
             });
        }
        
        function displayJadwalTable() {
            const tableBody = document.getElementById('jadwal-table-body');
            const dayOrder = { "Senin": 1, "Selasa": 2, "Rabu": 3, "Kamis": 4, "Jumat": 5, "Sabtu": 6, "Minggu": 7 };

            const sortedJadwal = [...db.jadwals].sort((a, b) => {
                if (dayOrder[a.hari] !== dayOrder[b.hari]) {
                    return dayOrder[a.hari] - dayOrder[b.hari];
                }
                return a.jam_mulai.localeCompare(b.jam_mulai);
            });
            
            let html = '';
            let lastDay = '';
            sortedJadwal.forEach(j => {
                html += `<tr class="border-t dark:border-gray-600">`;

                if (j.hari !== lastDay) {
                    const dayCount = sortedJadwal.filter(item => item.hari === j.hari).length;
                    html += `<td class="p-4 align-top font-semibold" rowspan="${dayCount}">${j.hari}</td>`;
                    lastDay = j.hari;
                }

                html += `
                    <td class="p-4">${j.jam_mulai} - ${j.jam_selesai}</td>
                    <td class="p-4">${getKelasName(j.kelas_id)}</td>
                    <td class="p-4">${getMapelName(j.mapel_id)}</td>
                    <td class="p-4">${getGuruName(j.guru_id)}</td>
                    <td class="p-4">${getRuanganName(j.ruangan_id)}</td>
                    <td class="p-4">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${j.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${j.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                `;
            });


            tableBody.innerHTML = html;

            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openJadwalForm(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteJadwal(e.currentTarget.dataset.id)));
        }

        function openJadwalForm(jadwalId = null) {
            const jadwal = jadwalId ? db.jadwals.find(j => j.id == jadwalId) : {};
            const title = jadwalId ? 'Edit Jadwal' : 'Tambah Jadwal Baru';
            
            const formHTML = `
                <form id="jadwal-form" class="space-y-4">
                    <input type="hidden" name="id" value="${jadwal.id || ''}">
                    
                    <!-- Day and Time -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                            <label for="hari" class="block text-sm font-medium">Hari</label>
                            <select id="hari" name="hari" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                ${["Senin", "Selasa", "Rabu", "Kamis", "Jumat"].map(h => `<option value="${h}" ${jadwal.hari === h ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="jam_mulai" class="block text-sm font-medium">Jam Mulai</label>
                            <input type="time" id="jam_mulai" name="jam_mulai" value="${jadwal.jam_mulai || '07:00'}" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="jam_selesai" class="block text-sm font-medium">Jam Selesai</label>
                            <input type="time" id="jam_selesai" name="jam_selesai" value="${jadwal.jam_selesai || '08:30'}" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                        </div>
                    </div>
                    
                    <!-- Selects -->
                     <div>
                        <label for="kelas_id" class="block text-sm font-medium">Kelas</label>
                        <select id="kelas_id" name="kelas_id" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                            ${db.kelas.map(k => `<option value="${k.id}" ${jadwal.kelas_id == k.id ? 'selected' : ''}>${k.nama}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="mapel_id" class="block text-sm font-medium">Mata Pelajaran</label>
                        <select id="mapel_id" name="mapel_id" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                            ${db.mapels.map(m => `<option value="${m.id}" ${jadwal.mapel_id == m.id ? 'selected' : ''}>${m.nama}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="guru_id" class="block text-sm font-medium">Guru</label>
                        <select id="guru_id" name="guru_id" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                             ${db.gurus.map(g => `<option value="${g.id}" ${jadwal.guru_id == g.id ? 'selected' : ''}>${g.nama}</option>`).join('')}
                        </select>
                    </div>
                     <div>
                        <label for="ruangan_id" class="block text-sm font-medium">Ruangan</label>
                        <select id="ruangan_id" name="ruangan_id" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                            ${db.ruangans.map(r => `<option value="${r.id}" ${jadwal.ruangan_id == r.id ? 'selected' : ''}>${r.nama}</option>`).join('')}
                        </select>
                    </div>
                    
                    <p id="conflict-error" class="text-sm text-red-500 hidden"></p>

                    <div class="flex justify-end pt-4">
                        <button type="button" id="cancel-btn" class="bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg mr-2">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">${jadwalId ? 'Update' : 'Simpan'}</button>
                    </div>
                </form>
            `;
            openAdminModal(title, formHTML);
            document.getElementById('jadwal-form').addEventListener('submit', handleJadwalSubmit);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
        }

        function handleJadwalSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newJadwal = Object.fromEntries(formData.entries());
            const errorEl = document.getElementById('conflict-error');
            
            // Check for conflict with other classes
            const classConflict = db.jadwals.find(j => {
                if (newJadwal.id && j.id == newJadwal.id) return false; // Don't check against itself when editing
                const isSameDay = j.hari === newJadwal.hari;
                const timeOverlap = (newJadwal.jam_mulai < j.jam_selesai && newJadwal.jam_selesai > j.jam_mulai);
                if (isSameDay && timeOverlap) {
                    if (j.guru_id == newJadwal.guru_id) return { type: 'Guru', name: getGuruName(j.guru_id) };
                    if (j.kelas_id == newJadwal.kelas_id) return { type: 'Kelas', name: getKelasName(j.kelas_id) };
                    if (j.ruangan_id == newJadwal.ruangan_id) return { type: 'Ruangan', name: getRuanganName(j.ruangan_id) };
                }
                return null;
            });
            
            // Check for conflict with special events (breaks, prayers)
            const specialEventConflict = db.acaraSekolah.find(a => {
                const timeOverlap = (newJadwal.jam_mulai < a.jam_selesai && newJadwal.jam_selesai > a.jam_mulai);
                return timeOverlap ? { nama: a.nama } : null;
            });

            if (classConflict) {
                errorEl.textContent = `Konflik! ${classConflict.type} ${classConflict.name} sudah terjadwal pada waktu yang sama.`;
                errorEl.classList.remove('hidden');
                return;
            }

            if (specialEventConflict) {
                 errorEl.textContent = `Konflik! Jadwal tumpang tindih dengan waktu ${specialEventConflict.nama}.`;
                 errorEl.classList.remove('hidden');
                 return;
            }

            if (newJadwal.id) { // Update existing
                const index = db.jadwals.findIndex(j => j.id == newJadwal.id);
                db.jadwals[index] = { ...db.jadwals[index], ...newJadwal };
            } else { // Create new
                newJadwal.id = Date.now(); // Simple unique ID
                db.jadwals.push(newJadwal);
            }
            closeModal();
            renderAdminJadwal();
        }

        function deleteJadwal(jadwalId) {
            if (confirm('Apakah Anda yakin ingin menghapus jadwal ini?')) {
                db.jadwals = db.jadwals.filter(j => j.id != jadwalId);
                renderAdminJadwal();
            }
        }
        
        // --- ADMIN: Kalender ---
        function renderKalender() {
            mainContent.innerHTML = `<div id="calendar-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg"><div id="calendar"></div></div>`;
            const calendarEl = document.getElementById('calendar');
            const dayMap = { 'Senin': 1, 'Selasa': 2, 'Rabu': 3, 'Kamis': 4, 'Jumat': 5 };

            // Function to generate a color from a string
            const stringToColor = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'];
                return colors[Math.abs(hash % colors.length)];
            };

            const classEvents = db.jadwals.map(j => {
                const mapelName = getMapelName(j.mapel_id);
                const color = stringToColor(mapelName);
                return {
                    title: `${mapelName}`,
                    startTime: j.jam_mulai,
                    endTime: j.jam_selesai,
                    daysOfWeek: [dayMap[j.hari]],
                    backgroundColor: color,
                    borderColor: color,
                    extendedProps: {
                        guru: getGuruName(j.guru_id),
                        ruangan: getRuanganName(j.ruangan_id),
                        kelas: getKelasName(j.kelas_id),
                    }
                }
            });

            const specialEvents = db.acaraSekolah.map(a => {
                const colors = {
                    break: { bg: '#6b7280', border: '#6b7280' },
                    prayer: { bg: '#10b981', border: '#10b981' },
                    school_time: { bg: '#f59e0b', border: '#f59e0b'}
                };
                return {
                    title: a.nama,
                    startTime: a.jam_mulai,
                    endTime: a.jam_selesai,
                    daysOfWeek: [1, 2, 3, 4, 5], // Monday to Friday
                    backgroundColor: colors[a.type].bg,
                    borderColor: colors[a.type].border,
                    display: 'background' // Display as background event
                };
            });

            state.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                events: [...classEvents, ...specialEvents],
                slotMinTime: "06:00:00",
                slotMaxTime: "18:00:00",
                allDaySlot: false,
                locale: 'id',
                buttonText: {
                    today:    'Hari Ini',
                    month:    'Bulan',
                    week:     'Minggu',
                    day:      'Hari',
                    list:     'Agenda'
                },
                eventContent: function(arg) {
                    if (arg.event.display === 'background') {
                        return { html: `<div class="p-1 font-semibold text-center">${arg.event.title}</div>`};
                    }
                    const { guru, ruangan, kelas } = arg.event.extendedProps;
                    return {
                        html: `
                            <div class="p-1 overflow-hidden h-full">
                                <div class="font-semibold text-white">${arg.timeText}</div>
                                <div class="text-white font-bold whitespace-nowrap overflow-hidden text-ellipsis">${arg.event.title}</div>
                                <div class="text-white text-xs whitespace-nowrap overflow-hidden text-ellipsis"><i class="fas fa-chalkboard-teacher mr-1"></i>${guru}</div>
                                <div class="text-white text-xs whitespace-nowrap overflow-hidden text-ellipsis"><i class="fas fa-university mr-1"></i>${kelas}</div>
                                <div class="text-white text-xs whitespace-nowrap overflow-hidden text-ellipsis"><i class="fas fa-map-marker-alt mr-1"></i>${ruangan}</div>
                            </div>
                        `
                    };
                }
            });
            state.calendar.render();
        }

        // --- ADMIN: Log Aktivitas ---
        function renderAdminLogs() {
             mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Log Aktivitas Pengguna</h2>
                </div>
                <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                     <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-4">Waktu</th>
                                <th class="p-4">Username</th>
                                <th class="p-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
             `;
             
             const tableBody = document.getElementById('logs-table-body');
             if (db.logs.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Belum ada aktivitas.</td></tr>`;
                 return;
             }

             const sortedLogs = [...db.logs].sort((a, b) => b.timestamp - a.timestamp); // Newest first
             
             tableBody.innerHTML = sortedLogs.map(log => {
                const actionText = {
                    login: '<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Login</span>',
                    logout: '<span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:bg-red-700 dark:text-red-100">Logout</span>',
                    daftar: '<span class="px-2 py-1 font-semibold leading-tight text-blue-700 bg-blue-100 rounded-full dark:bg-blue-700 dark:text-blue-100">Daftar</span>'
                };
                return `
                     <tr class="border-t dark:border-gray-600">
                        <td class="p-4">${log.timestamp.toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'medium' })}</td>
                        <td class="p-4">${log.user}</td>
                        <td class="p-4">${actionText[log.action] || log.action}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // --- ADMIN: Kelola Pengguna (Siswa, Guru, Kelas) ---
        function renderAdminPengguna() {
            mainContent.innerHTML = `
                 <h2 class="text-3xl font-bold mb-4">Kelola Data Sekolah</h2>
                 <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav id="user-management-tabs" class="flex space-x-4 p-4" aria-label="Tabs">
                            <button data-tab="siswa" class="tab-btn px-3 py-2 font-medium text-sm rounded-md active">Siswa</button>
                            <button data-tab="guru" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Guru</button>
                            <button data-tab="kelas" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Kelas</button>
                            <button data-tab="acara" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Acara Sekolah</button>
                        </nav>
                    </div>
                    <!-- Tab Content -->
                    <div id="user-management-content" class="p-4">
                        <!-- Content will be injected here -->
                    </div>
                 </div>
            `;
            
            const tabsContainer = document.getElementById('user-management-tabs');
            const tabContentContainer = document.getElementById('user-management-content');

            const tabViews = {
                siswa: displaySiswaTable,
                guru: displayGuruTable,
                kelas: displayKelasTable,
                acara: displayAcaraTable,
            };
            
            tabsContainer.addEventListener('click', e => {
                if (e.target.matches('.tab-btn')) {
                    tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    const tabName = e.target.dataset.tab;
                    tabViews[tabName](tabContentContainer);
                }
            });

            // Initial view
            tabViews.siswa(tabContentContainer);
        }

        function displaySiswaTable(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Daftar Siswa</h3>
                    <button id="add-siswa-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${['Nama', 'NIS', 'Kelas', 'Aksi'].map(h => `<th class="p-4">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${db.siswas.map(s => `
                                <tr class="border-t dark:border-gray-600">
                                    <td class="p-4">${s.nama}</td>
                                    <td class="p-4">${s.nis}</td>
                                    <td class="p-4">${getKelasName(s.kelas_id)}</td>
                                    <td class="p-4">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${s.id}" data-type="siswa"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${s.id}" data-type="siswa"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.querySelector('#add-siswa-btn').addEventListener('click', () => openSiswaForm());
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openSiswaForm(e.currentTarget.dataset.id)));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteSiswa(e.currentTarget.dataset.id)));
        }

        function displayGuruTable(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Daftar Guru</h3>
                    <button id="add-guru-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Tambah Guru</button>
                </div>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${['Nama', 'Mapel Utama', 'Aksi'].map(h => `<th class="p-4">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                             ${db.gurus.map(g => `
                                <tr class="border-t dark:border-gray-600">
                                    <td class="p-4">${g.nama}</td>
                                    <td class="p-4">${g.mapel}</td>
                                    <td class="p-4">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${g.id}" data-type="guru"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${g.id}" data-type="guru"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.querySelector('#add-guru-btn').addEventListener('click', () => openGuruForm());
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openGuruForm(e.currentTarget.dataset.id)));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteGuru(e.currentTarget.dataset.id)));
        }
        
        function displayKelasTable(container) {
             container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Daftar Kelas</h3>
                    <button id="add-kelas-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Tambah Kelas</button>
                </div>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${['Nama Kelas', 'Aksi'].map(h => `<th class="p-4">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                             ${db.kelas.map(k => `
                                <tr class="border-t dark:border-gray-600">
                                    <td class="p-4">${k.nama}</td>
                                    <td class="p-4">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${k.id}" data-type="kelas"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${k.id}" data-type="kelas"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.querySelector('#add-kelas-btn').addEventListener('click', () => openKelasForm());
             container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openKelasForm(e.currentTarget.dataset.id)));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteKelas(e.currentTarget.dataset.id)));
        }

        function displayAcaraTable(container) {
             container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Daftar Acara Sekolah</h3>
                    <button id="add-acara-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Tambah Acara</button>
                </div>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${['Nama Acara', 'Waktu', 'Tipe', 'Aksi'].map(h => `<th class="p-4">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                             ${db.acaraSekolah.map(a => `
                                <tr class="border-t dark:border-gray-600">
                                    <td class="p-4">${a.nama}</td>
                                    <td class="p-4">${a.jam_mulai} - ${a.jam_selesai}</td>
                                    <td class="p-4">${a.type}</td>
                                    <td class="p-4">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${a.id}" data-type="acara"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${a.id}" data-type="acara"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.querySelector('#add-acara-btn').addEventListener('click', () => openAcaraForm());
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openAcaraForm(e.currentTarget.dataset.id)));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteAcara(e.currentTarget.dataset.id)));
        }
        
        // --- ADMIN: Pengguna Forms & Handlers ---

        function openSiswaForm(id = null) {
            const siswa = id ? db.siswas.find(s => s.id == id) : {};
            const title = id ? 'Edit Siswa' : 'Tambah Siswa Baru';
            const user = id ? db.users.find(u => u.detail_id === siswa.id && u.role === 'siswa') : {};
            
            const formHTML = `
                <form id="siswa-form" class="space-y-4">
                    <input type="hidden" name="id" value="${siswa.id || ''}">
                    ${id ? '' : `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">Username</label>
                            <input type="text" name="username" placeholder="Username untuk login" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Password</label>
                            <input type="password" name="password" placeholder="Password untuk login" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <p id="form-error" class="text-sm text-red-500 hidden"></p>
                    <hr class="dark:border-gray-600"/>
                    `}
                    <div>
                        <label class="block text-sm font-medium">Nama Lengkap</label>
                        <input type="text" name="nama" value="${siswa.nama || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">NIS</label>
                            <input type="text" name="nis" value="${siswa.nis || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                        <div>
                           <label class="block text-sm font-medium">Kelas</label>
                            <select name="kelas_id" required class="mt-1 block w-full p-2 border rounded-md">
                                ${db.kelas.map(k => `<option value="${k.id}" ${siswa.kelas_id == k.id ? 'selected' : ''}>${k.nama}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button" class="cancel-btn bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg mr-2">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">${id ? 'Update' : 'Simpan'}</button>
                    </div>
                </form>
            `;
            openAdminModal(title, formHTML);
            document.getElementById('siswa-form').addEventListener('submit', handleSiswaSubmit);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        }

        function handleSiswaSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (data.id) { // Editing
                const siswaIndex = db.siswas.findIndex(s => s.id == data.id);
                db.siswas[siswaIndex].nama = data.nama;
                db.siswas[siswaIndex].nis = data.nis;
                db.siswas[siswaIndex].kelas_id = parseInt(data.kelas_id);
            } else { // Adding
                 if (db.users.find(u => u.username === data.username)) {
                    document.getElementById('form-error').textContent = 'Username sudah digunakan.';
                    document.getElementById('form-error').classList.remove('hidden');
                    return;
                }
                const newSiswaId = (db.siswas.length > 0 ? Math.max(...db.siswas.map(s => s.id)) : 100) + 1;
                const newUserId = (db.users.length > 0 ? Math.max(...db.users.map(u => u.id)) : 0) + 1;

                db.siswas.push({ id: newSiswaId, nama: data.nama, nis: data.nis, kelas_id: parseInt(data.kelas_id) });
                db.users.push({ id: newUserId, username: data.username, password: data.password, role: 'siswa', detail_id: newSiswaId, approved: true }); // Auto-approve when admin adds
            }
            closeModal();
            renderAdminPengguna();
        }

        function deleteSiswa(id) {
            if (confirm('Menghapus siswa juga akan menghapus akun login mereka. Lanjutkan?')) {
                db.siswas = db.siswas.filter(s => s.id != id);
                db.users = db.users.filter(u => !(u.role === 'siswa' && u.detail_id == id));
                renderAdminPengguna();
            }
        }
        
        function openGuruForm(id = null) {
            const guru = id ? db.gurus.find(g => g.id == id) : {};
            const title = id ? 'Edit Guru' : 'Tambah Guru Baru';

            const formHTML = `
                <form id="guru-form" class="space-y-4">
                    <input type="hidden" name="id" value="${guru.id || ''}">
                     ${id ? '' : `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">Username</label>
                            <input type="text" name="username" placeholder="Username untuk login" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Password</label>
                            <input type="password" name="password" placeholder="Password untuk login" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <p id="form-error" class="text-sm text-red-500 hidden"></p>
                    <hr class="dark:border-gray-600"/>
                    `}
                    <div>
                        <label class="block text-sm font-medium">Nama Lengkap</label>
                        <input type="text" name="nama" value="${guru.nama || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Mapel Utama</label>
                        <input type="text" name="mapel" value="${guru.mapel || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button" class="cancel-btn bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg mr-2">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">${id ? 'Update' : 'Simpan'}</button>
                    </div>
                </form>
            `;
            openAdminModal(title, formHTML);
            document.getElementById('guru-form').addEventListener('submit', handleGuruSubmit);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        }

        function handleGuruSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (data.id) { // Editing
                const guruIndex = db.gurus.findIndex(g => g.id == data.id);
                db.gurus[guruIndex].nama = data.nama;
                db.gurus[guruIndex].mapel = data.mapel;
            } else { // Adding
                if (db.users.find(u => u.username === data.username)) {
                    document.getElementById('form-error').textContent = 'Username sudah digunakan.';
                    document.getElementById('form-error').classList.remove('hidden');
                    return;
                }
                const newGuruId = (db.gurus.length > 0 ? Math.max(...db.gurus.map(g => g.id)) : 200) + 1;
                const newUserId = (db.users.length > 0 ? Math.max(...db.users.map(u => u.id)) : 0) + 1;
                db.gurus.push({ id: newGuruId, nama: data.nama, mapel: data.mapel });
                db.users.push({ id: newUserId, username: data.username, password: data.password, role: 'guru', detail_id: newGuruId, approved: true }); // Auto-approve
            }
            closeModal();
            renderAdminPengguna();
            // Switch to guru tab after action
            document.querySelector('.tab-btn[data-tab="guru"]').click();
        }

        function deleteGuru(id) {
             if (confirm('Menghapus guru juga akan menghapus akun login mereka. Lanjutkan?')) {
                db.gurus = db.gurus.filter(g => g.id != id);
                db.users = db.users.filter(u => !(u.role === 'guru' && u.detail_id == id));
                renderAdminPengguna();
                document.querySelector('.tab-btn[data-tab="guru"]').click();
            }
        }
        
         function openKelasForm(id = null) {
            const kelas = id ? db.kelas.find(k => k.id == id) : {};
            const title = id ? 'Edit Kelas' : 'Tambah Kelas Baru';

            const formHTML = `
                <form id="kelas-form" class="space-y-4">
                    <input type="hidden" name="id" value="${kelas.id || ''}">
                    <div>
                        <label class="block text-sm font-medium">Nama Kelas</label>
                        <input type="text" name="nama" value="${kelas.nama || ''}" placeholder="Contoh: 12-C" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button" class="cancel-btn bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg mr-2">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">${id ? 'Update' : 'Simpan'}</button>
                    </div>
                </form>
            `;
            openAdminModal(title, formHTML);
            document.getElementById('kelas-form').addEventListener('submit', handleKelasSubmit);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        }

        function handleKelasSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (data.id) { // Editing
                const kelasIndex = db.kelas.findIndex(k => k.id == data.id);
                db.kelas[kelasIndex].nama = data.nama;
            } else { // Adding
                const newKelasId = (db.kelas.length > 0 ? Math.max(...db.kelas.map(k => k.id)) : 0) + 1;
                db.kelas.push({ id: newKelasId, nama: data.nama });
            }
            closeModal();
            renderAdminPengguna();
            document.querySelector('.tab-btn[data-tab="kelas"]').click();
        }

        function deleteKelas(id) {
            if (db.siswas.some(s => s.kelas_id == id)) {
                alert('Tidak bisa menghapus kelas karena masih ada siswa di dalamnya.');
                return;
            }
            if (confirm('Apakah Anda yakin ingin menghapus kelas ini?')) {
                db.kelas = db.kelas.filter(k => k.id != id);
                renderAdminPengguna();
                document.querySelector('.tab-btn[data-tab="kelas"]').click();
            }
        }

        function openAcaraForm(id = null) {
            const acara = id ? db.acaraSekolah.find(a => a.id == id) : {};
            const title = id ? 'Edit Acara Sekolah' : 'Tambah Acara Sekolah';

            const formHTML = `
                <form id="acara-form" class="space-y-4">
                    <input type="hidden" name="id" value="${acara.id || ''}">
                    <div>
                        <label class="block text-sm font-medium">Nama Acara</label>
                        <input type="text" name="nama" value="${acara.nama || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-medium">Jam Mulai</label>
                            <input type="time" name="jam_mulai" value="${acara.jam_mulai || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                         <div>
                            <label class="block text-sm font-medium">Jam Selesai</label>
                            <input type="time" name="jam_selesai" value="${acara.jam_selesai || ''}" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Tipe</label>
                        <select name="type" required class="mt-1 block w-full p-2 border rounded-md">
                            <option value="break" ${acara.type === 'break' ? 'selected' : ''}>Istirahat (break)</option>
                            <option value="prayer" ${acara.type === 'prayer' ? 'selected' : ''}>Sholat (prayer)</option>
                            <option value="school_time" ${acara.type === 'school_time' ? 'selected' : ''}>Waktu Sekolah (school_time)</option>
                        </select>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button" class="cancel-btn bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg mr-2">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">${id ? 'Update' : 'Simpan'}</button>
                    </div>
                </form>
            `;
            openAdminModal(title, formHTML);
            document.getElementById('acara-form').addEventListener('submit', handleAcaraSubmit);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        }

        function handleAcaraSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
             if (data.id) { // Editing
                const index = db.acaraSekolah.findIndex(a => a.id == data.id);
                db.acaraSekolah[index] = { ...db.acaraSekolah[index], ...data };
            } else { // Adding
                const newId = (db.acaraSekolah.length > 0 ? Math.max(...db.acaraSekolah.map(a => a.id)) : 900) + 1;
                db.acaraSekolah.push({ id: newId, ...data });
            }
            closeModal();
            renderAdminPengguna();
            document.querySelector('.tab-btn[data-tab="acara"]').click();
        }

        function deleteAcara(id) {
            if (confirm('Apakah Anda yakin ingin menghapus acara ini?')) {
                db.acaraSekolah = db.acaraSekolah.filter(a => a.id != id);
                renderAdminPengguna();
                document.querySelector('.tab-btn[data-tab="acara"]').click();
            }
        }
        
        // --- MODAL & NOTIFICATION ---
        function openAdminModal(title, content) {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalBody.innerHTML = '';
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
             if (e.target === modal) closeModal(); // Close if backdrop is clicked
        });
        
        function setupNotifications() {
             const unreadCount = db.pengumumans.filter(p => !p.read).length;
             if (unreadCount > 0) {
                 notificationDot.classList.remove('hidden');
             } else {
                 notificationDot.classList.add('hidden');
             }
        }

        notificationBtn.addEventListener('click', () => {
             const announcementsHTML = `
                <div class="space-y-4">
                    ${db.pengumumans.map(p => `
                        <div class="p-3 rounded-md ${p.read ? 'bg-gray-100 dark:bg-gray-700' : 'bg-blue-100 dark:bg-blue-900'}">
                            <p class="font-bold">${p.judul}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${p.tanggal}</p>
                            <p class="mt-1">${p.isi}</p>
                        </div>
                    `).join('') || '<p>Tidak ada pengumuman.</p>'}
                </div>
             `;
             openAdminModal('Pengumuman', announcementsHTML);
             // Mark all as read
             db.pengumumans.forEach(p => p.read = true);
             setupNotifications();
        });


        // --- EXPORT & UTILITY ---
        function exportJadwal(format, title, data, role) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const head = [['Waktu', 'Kegiatan', role === 'siswa' ? 'Guru' : 'Kelas', 'Ruangan']];
            const body = [];
            
            const dayOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
            dayOrder.forEach(hari => {
                const jadwalHari = data.filter(j => j.hari === hari);
                const acaraHariIni = [...jadwalHari, ...db.acaraSekolah].sort((a,b) => a.jam_mulai.localeCompare(b.jam_mulai));

                if (acaraHariIni.length > 0) {
                    body.push([{ content: hari, colSpan: 4, styles: { fontStyle: 'bold', fillColor: '#d3d3d3', textColor: '#000' } }]);
                    acaraHariIni.forEach(j => {
                         if (j.type) {
                            body.push([
                                `${j.jam_mulai} - ${j.jam_selesai}`,
                                j.nama,
                                '-',
                                '-'
                            ]);
                         } else {
                            body.push([
                                `${j.jam_mulai} - ${j.jam_selesai}`,
                                getMapelName(j.mapel_id),
                                role === 'siswa' ? getGuruName(j.guru_id) : getKelasName(j.kelas_id),
                                getRuanganName(j.ruangan_id)
                            ]);
                         }
                    });
                }
            });

            if (format === 'pdf') {
                doc.autoTable({
                    head: head,
                    body: body,
                    didDrawPage: function(data) {
                        doc.text(title, data.settings.margin.left, 15);
                    },
                    headStyles: { fillColor: [41, 128, 185] }
                });
                doc.save(`${title.replace(/\s/g, '_')}.pdf`);
            } else if (format === 'excel') {
                 // Flatten body for Excel, replacing colspan objects with plain text
                const excelBody = body.map(row => {
                    if (row[0].colSpan) { // This is a day header
                        return [row[0].content, '', '', ''];
                    }
                    return row;
                });
                
                const worksheetData = [
                    [title], // Title row
                    [], // Empty row
                    head[0], // Header row
                    ...excelBody
                ];

                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Jadwal");
                XLSX.writeFile(workbook, `${title.replace(/\s/g, '_')}.xlsx`);
            }
        }
    });
    </script>
</body>
</html>            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-blue-900 text-white flex flex-col">
            <div class="p-6 text-center border-b border-blue-800">
                <h1 class="text-xl font-bold">Portal Sekolah</h1>
                <p id="school-name-sidebar" class="text-sm text-blue-300">SMA NEGERI 1 DRAMAGA</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" id="nav-beranda" class="sidebar-item active flex items-center p-3 rounded-lg">
                    <i class="fas fa-home w-6"></i><span>Beranda</span>
                </a>
                <a href="#" id="nav-profil" class="sidebar-item flex items-center p-3 rounded-lg">
                    <i class="fas fa-school w-6"></i><span>Profil Sekolah</span>
                </a>
                <a href="#" id="nav-jadwal" class="sidebar-item flex items-center p-3 rounded-lg">
                    <i class="fas fa-calendar-alt w-6"></i><span>Jadwal Pelajaran</span>
                </a>
                <a href="#" id="nav-pengumuman" class="sidebar-item flex items-center p-3 rounded-lg">
                    <i class="fas fa-bullhorn w-6"></i><span>Pengumuman</span>
                </a>
                <a href="#" id="nav-absensi" class="sidebar-item flex items-center p-3 rounded-lg">
                    <i class="fas fa-user-check w-6"></i><span>Absensi</span>
                </a>
                <a href="#" id="nav-siswa" class="sidebar-item flex items-center p-3 rounded-lg">
                    <i class="fas fa-users w-6"></i><span>Data Siswa</span>
                </a>
            </nav>
            <div class="p-4 border-t border-blue-800">
                <div id="user-info" class="text-center">
                    <!-- User Info akan diisi oleh JavaScript -->
                </div>
                <div class="mt-4 flex justify-center space-x-2">
                    <button id="switch-to-teacher" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Guru</button>
                    <button id="switch-to-parent" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Orang Tua</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div id="content">
                <!-- Konten dinamis akan dimuat di sini -->
            </div>
        </main>
    </div>

    <!-- Modal untuk Tambah Pengumuman -->
    <div id="announcement-modal-backdrop" class="modal-backdrop"></div>
    <div id="announcement-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">Tambah Pengumuman Baru</h2>
        </div>
        <div class="p-6">
            <form id="announcement-form">
                <div class="mb-4">
                    <label for="announcement-title" class="block text-sm font-medium text-gray-700">Judul</label>
                    <input type="text" id="announcement-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="announcement-content" class="block text-sm font-medium text-gray-700">Isi Pengumuman</label>
                    <textarea id="announcement-content" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required></textarea>
                </div>
            </form>
        </div>
        <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
            <button id="cancel-announcement" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
            <button id="save-announcement" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
        </div>
    </div>
    
    <!-- Modal untuk Edit Profil Sekolah -->
    <div id="profile-modal-backdrop" class="modal-backdrop"></div>
    <div id="profile-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">Edit Profil Sekolah</h2>
        </div>
        <div class="p-6">
            <form id="profile-form">
                <div class="mb-4">
                    <label for="profile-name" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                    <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="profile-address" class="block text-sm font-medium text-gray-700">Alamat</label>
                    <input type="text" id="profile-address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="profile-vision" class="block text-sm font-medium text-gray-700">Visi</label>
                    <textarea id="profile-vision" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <div>
                    <label for="profile-mission" class="block text-sm font-medium text-gray-700">Misi</label>
                    <textarea id="profile-mission" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
            </form>
        </div>
        <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
            <button id="cancel-profile" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
            <button id="save-profile" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
        </div>
    </div>


    <script type="module">
        // Import fungsi-fungsi yang diperlukan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
        
        // ID Aplikasi untuk path Firestore
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- State Aplikasi ---
        let currentUser = null; // Akan berisi data pengguna yang sedang login
        let currentView = 'beranda'; // Halaman yang sedang ditampilkan
        let unsubscribeListeners = []; // Untuk menyimpan listener onSnapshot

        // --- Data Dummy & Pengguna Simulasi ---
        function generateClassList() {
            const grades = [10, 11, 12];
            const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
            const classList = [];
            grades.forEach(grade => {
                letters.forEach(letter => {
                    classList.push(`Kelas ${grade}${letter}`);
                });
            });
            return classList;
        }

        const teacherUser = {
            uid: 'guru01',
            nama: 'Ibu Budiarti',
            role: 'teacher',
            kelasWali: generateClassList()
        };
        const parentUser = {
            uid: 'ortu01',
            nama: 'Bapak Agus',
            role: 'parent',
            childId: 'siswa01' // ID anak dari orang tua ini
        };

        // --- Fungsi Utama ---
        async function initializeAppLogic() {
            // Login menggunakan token kustom jika tersedia, jika tidak, login anonim
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User signed in:", user.uid);
                    await setupInitialData();
                    await switchUser('teacher');
                } else {
                    console.log("User is signed out.");
                }
            });
        }

        // Fungsi untuk membuat data awal di Firestore jika belum ada
        async function setupInitialData() {
            const schoolProfileRef = doc(db, "artifacts", appId, "public", "data", "school", "profile");
            const schoolProfileSnap = await getDoc(schoolProfileRef);

            if (!schoolProfileSnap.exists()) {
                console.log("Setting up initial school data...");
                // Data Profil Sekolah
                await setDoc(schoolProfileRef, {
                    nama: "SMA NEGERI 1 DRAMAGA",
                    alamat: "Jalan Raya Dramaga KM 07, Desa Dramaga, Kecamatan Dramaga, Kabupaten Bogor, Jawa Barat 16680",
                    telepon: "0251-8621234",
                    email: "info@sman1dramaga.sch.id",
                    visi: "Terwujudnya sekolah yang unggul dalam prestasi, berkarakter, dan berwawasan lingkungan.",
                    misi: "1. Melaksanakan pembelajaran dan bimbingan secara efektif...\n2. Mendorong dan membantu siswa untuk mengenali potensi dirinya...\n3. Menumbuhkan semangat keunggulan secara intensif..."
                });

                // Data Siswa
                const students = [
                    { id: 'siswa01', nama: 'Ahmad Dahlan', kelas: 'Kelas 10A', ortu: 'Bapak Agus' },
                    { id: 'siswa02', nama: 'Siti Aminah', kelas: 'Kelas 10A', ortu: 'Ibu Wati' },
                    { id: 'siswa03', nama: 'Bambang Susilo', kelas: 'Kelas 10B', ortu: 'Bapak Joko' },
                    { id: 'siswa04', nama: 'Dewi Lestari', kelas: 'Kelas 10B', ortu: 'Ibu Rina' },
                    { id: 'siswa05', nama: 'Eko Prasetyo', kelas: 'Kelas 11C', ortu: 'Bapak Budi' },
                    { id: 'siswa06', nama: 'Fitriani', kelas: 'Kelas 11C', ortu: 'Ibu Sri' },
                    { id: 'siswa07', nama: 'Gunawan', kelas: 'Kelas 12L', ortu: 'Bapak Heru' },
                    { id: 'siswa08', nama: 'Herlina', kelas: 'Kelas 12L', ortu: 'Ibu Endang' },
                    { id: 'siswa09', nama: 'Indra Jaya', kelas: 'Kelas 11G', ortu: 'Bapak Surya' },
                    { id: 'siswa10', nama: 'Joko Widodo', kelas: 'Kelas 12A', ortu: 'Bapak Noto' },
                    { id: 'siswa11', nama: 'Kartini', kelas: 'Kelas 10L', ortu: 'Ibu Ngasirah' },
                ];
                for (const student of students) {
                    await setDoc(doc(db, "artifacts", appId, "public", "data", "students", student.id), student);
                }

                // Data Guru
                const teachers = [
                    { nama: 'Drs. H. Abdullah, M.Pd.', mapel: 'Kepala Sekolah' },
                    { nama: 'Dra. Sri Rahayu', mapel: 'Wakil Kepala Sekolah' },
                    { nama: 'Budi Santoso, S.Pd.', mapel: 'Matematika' },
                    { nama: 'Siti Aminah, S.S.', mapel: 'Bahasa Indonesia' },
                    { nama: 'Dr. Iwan Setiawan, M.Si.', mapel: 'Fisika & Kimia' },
                    { nama: 'Dewi Lestari, S.Hum.', mapel: 'Bahasa Inggris' },
                    { nama: 'Agus Purnomo, S.E.', mapel: 'Ekonomi' },
                    { nama: 'Rina Maryati, S.Ag.', mapel: 'Pendidikan Agama' },
                ];
                for (const teacher of teachers) {
                    await addDoc(collection(db, "artifacts", appId, "public", "data", "teachers"), teacher);
                }


                // Data Pengumuman
                await addDoc(collection(db, "artifacts", appId, "public", "data", "announcements"), {
                    judul: "Selamat Datang di Portal SMAN 1 Dramaga",
                    isi: "Ini adalah portal informasi baru untuk SMAN 1 Dramaga. Semua informasi penting akan diperbarui di sini.",
                    tanggal: new Date()
                });
                
                // Data Absensi (contoh untuk 1 hari)
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                await setDoc(doc(db, "artifacts", appId, "public", "data", "attendance", today), {
                    'siswa01': 'Hadir', 'siswa02': 'Hadir', 'siswa03': 'Sakit', 'siswa04': 'Hadir',
                    'siswa05': 'Izin', 'siswa06': 'Hadir', 'siswa07': 'Alfa', 'siswa08': 'Hadir',
                    'siswa09': 'Hadir', 'siswa10': 'Sakit', 'siswa11': 'Hadir',
                });
            }
        }

        // --- Fungsi Render Konten ---
        function renderContent(view) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x"></i></div>';
            
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            switch (view) {
                case 'beranda': renderBeranda(content); break;
                case 'profil': renderProfil(content); break;
                case 'jadwal': renderJadwal(content); break;
                case 'pengumuman': renderPengumuman(content); break;
                case 'absensi': renderAbsensi(content); break;
                case 'siswa': renderSiswa(content); break;
            }
            updateActiveNav(view);
        }

        async function renderBeranda(container) {
            const profileRef = doc(db, "artifacts", appId, "public", "data", "school", "profile");
            const profileSnap = await getDoc(profileRef);

            if (!profileSnap.exists()) {
                container.innerHTML = `<div class="text-center p-10"><h2 class="text-xl">Data profil sekolah tidak ditemukan.</h2></div>`;
                return;
            }

            const profileData = profileSnap.data();
            document.getElementById('school-name-sidebar').textContent = profileData.nama;

            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Selamat Datang di Portal ${profileData.nama}</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-3"><i class="fas fa-school mr-2 text-blue-600"></i>Profil Singkat</h2>
                        <p><strong>Alamat:</strong> ${profileData.alamat}</p>
                        <p><strong>Email:</strong> ${profileData.email}</p>
                        <p><strong>Telepon:</strong> ${profileData.telepon}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-3"><i class="fas fa-bullhorn mr-2 text-yellow-500"></i>Pengumuman Terbaru</h2>
                        <div id="latest-announcements">Memuat...</div>
                    </div>
                </div>
            `;

            const q = query(collection(db, "artifacts", appId, "public", "data", "announcements"));
            const unsub = onSnapshot(q, (querySnapshot) => {
                const announcementsDiv = document.getElementById('latest-announcements');
                if (!announcementsDiv) return;
                let announcementsHTML = '<ul class="space-y-2">';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    announcementsHTML += `<li class="border-b pb-2"><strong>${data.judul}</strong><p class="text-sm text-gray-600">${data.isi.substring(0, 50)}...</p></li>`;
                });
                announcementsHTML += '</ul>';
                announcementsDiv.innerHTML = announcementsHTML;
            });
            unsubscribeListeners.push(unsub);
        }

        function renderProfil(container) {
            const unsubProfile = onSnapshot(doc(db, "artifacts", appId, "public", "data", "school", "profile"), (doc) => {
                if (!doc.exists()) {
                    container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Profil Sekolah Tidak Ditemukan</h1>`;
                    return;
                }
                const data = doc.data();
                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Profil Sekolah</h1>
                    <div class="bg-white p-8 rounded-lg shadow">
                        ${currentUser.role === 'teacher' ? '<button id="edit-profile-btn" class="float-right bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-edit mr-2"></i>Edit Profil</button>' : ''}
                        <h2 class="text-2xl font-semibold text-blue-800">${data.nama}</h2>
                        <p class="text-gray-600 mt-2"><i class="fas fa-map-marker-alt mr-2"></i>${data.alamat}</p>
                        <hr class="my-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Visi</h3>
                            <p class="text-gray-700 whitespace-pre-line">${data.visi}</p>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Misi</h3>
                            <p class="text-gray-700 whitespace-pre-line">${data.misi}</p>
                        </div>
                         <hr class="my-6">
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Staf Pengajar Unggulan</h3>
                            <div id="teacher-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Teacher list will be rendered here -->
                            </div>
                        </div>
                    </div>
                `;
                if (currentUser.role === 'teacher') {
                    document.getElementById('edit-profile-btn').addEventListener('click', openProfileModal);
                }
                renderTeacherList(); // Panggil fungsi untuk merender daftar guru
            });
            unsubscribeListeners.push(unsubProfile);

            async function renderTeacherList() {
                const teacherListDiv = document.getElementById('teacher-list');
                if (!teacherListDiv) return;
                teacherListDiv.innerHTML = 'Memuat...';
                const teachersQuery = query(collection(db, "artifacts", appId, "public", "data", "teachers"));
                const querySnapshot = await getDocs(teachersQuery);
                let teachersHTML = '';
                if (querySnapshot.empty) {
                    teachersHTML = '<p>Data guru tidak ditemukan.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const teacher = doc.data();
                        teachersHTML += `
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <p class="font-semibold text-gray-800">${teacher.nama}</p>
                                <p class="text-sm text-gray-600">${teacher.mapel}</p>
                            </div>
                        `;
                    });
                }
                teacherListDiv.innerHTML = teachersHTML;
            }
        }

        function renderJadwal(container) {
            const jadwal_10a = {
                'Senin': [
                    { jam: '07:00 - 07:30', pelajaran: 'Upacara Bendera' },
                    { jam: '07:30 - 09:00', pelajaran: 'Matematika Wajib' },
                    { jam: '09:00 - 10:30', pelajaran: 'Fisika' },
                    { jam: '10:30 - 11:00', pelajaran: 'Istirahat' },
                    { jam: '11:00 - 12:30', pelajaran: 'Bahasa Indonesia' },
                    { jam: '12:30 - 13:15', pelajaran: 'Istirahat Siang & Sholat' },
                    { jam: '13:15 - 14:45', pelajaran: 'Sejarah Indonesia' }
                ],
                'Selasa': [
                    { jam: '07:00 - 08:30', pelajaran: 'Bahasa Inggris' },
                    { jam: '08:30 - 10:00', pelajaran: 'Kimia' },
                    { jam: '10:00 - 10:30', pelajaran: 'Istirahat' },
                    { jam: '10:30 - 12:00', pelajaran: 'PPKn' },
                    { jam: '12:00 - 12:45', pelajaran: 'Istirahat Siang & Sholat' },
                    { jam: '12:45 - 14:15', pelajaran: 'PJOK' }
                ],
                'Rabu': [
                    { jam: '07:00 - 08:30', pelajaran: 'Biologi' },
                    { jam: '08:30 - 10:00', pelajaran: 'Bahasa Indonesia' },
                    { jam: '10:00 - 10:30', pelajaran: 'Istirahat' },
                    { jam: '10:30 - 12:00', pelajaran: 'Geografi' },
                    { jam: '12:00 - 12:45', pelajaran: 'Istirahat Siang & Sholat' },
                    { jam: '12:45 - 14:15', pelajaran: 'Pendidikan Agama' }
                ],
                'Kamis': [
                    { jam: '07:00 - 08:30', pelajaran: 'Matematika Peminatan' },
                    { jam: '08:30 - 10:00', pelajaran: 'Seni Budaya' },
                    { jam: '10:00 - 10:30', pelajaran: 'Istirahat' },
                    { jam: '10:30 - 12:00', pelajaran: 'Bahasa Inggris' },
                    { jam: '12:00 - 12:45', pelajaran: 'Istirahat Siang & Sholat' },
                    { jam: '12:45 - 14:15', pelajaran: 'TIK' }
                ],
                'Jumat': [
                    { jam: '07:00 - 09:00', pelajaran: 'Kegiatan Rohani / Literasi' },
                    { jam: '09:00 - 09:15', pelajaran: 'Istirahat' },
                    { jam: '09:15 - 11:15', pelajaran: 'Ekonomi' },
                    { jam: '11:15 - 13:00', pelajaran: 'Istirahat Panjang & Sholat Jumat' },
                    { jam: '13:00 - 14:30', pelajaran: 'Sosiologi' }
                ]
            };
            
            let html = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Jadwal Pelajaran</h1>`;
            html += '<p class="mb-4 text-gray-600">Berikut adalah jadwal untuk Kelas 10A.</p>';
            html += '<div class="space-y-6">';

            Object.keys(jadwal_10a).forEach(hari => {
                html += `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-4 text-blue-700">${hari}</h2>
                        <table class="w-full">
                            <tbody>
                `;
                jadwal_10a[hari].forEach(item => {
                    const isIstirahat = item.pelajaran.toLowerCase().includes('istirahat');
                    html += `
                        <tr class="border-b last:border-b-0">
                            <td class="py-3 px-2 w-1/3 text-gray-500">${item.jam}</td>
                            <td class="py-3 px-2 font-medium ${isIstirahat ? 'text-green-600' : 'text-gray-800'}">${item.pelajaran}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderPengumuman(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Pengumuman</h1>
                    ${currentUser.role === 'teacher' ? '<button id="add-announcement-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Buat Baru</button>' : ''}
                </div>
                <div id="announcement-list" class="space-y-4"></div>
            `;
            
            if (currentUser.role === 'teacher') {
                document.getElementById('add-announcement-btn').addEventListener('click', openAnnouncementModal);
            }

            const q = query(collection(db, "artifacts", appId, "public", "data", "announcements"));
            const unsub = onSnapshot(q, (querySnapshot) => {
                const list = document.getElementById('announcement-list');
                if (!list) return;
                list.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.tanggal.toDate().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow';
                    card.innerHTML = `
                        <h2 class="text-xl font-semibold text-blue-800">${data.judul}</h2>
                        <p class="text-sm text-gray-500 mb-3">${date}</p>
                        <p class="text-gray-700 whitespace-pre-line">${data.isi}</p>
                    `;
                    list.appendChild(card);
                });
            });
            unsubscribeListeners.push(unsub);
        }

        function renderAbsensi(container) {
            const today = new Date().toISOString().slice(0, 10);
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Absensi Siswa - ${new Date().toLocaleDateString('id-ID', { dateStyle: 'full' })}</h1>
                <div id="attendance-view"></div>
            `;

            if (currentUser.role === 'teacher') {
                const attendanceView = document.getElementById('attendance-view');
                let classOptions = '';
                currentUser.kelasWali.forEach(kelas => {
                    classOptions += `<option value="${kelas}">${kelas}</option>`;
                });

                attendanceView.innerHTML = `
                    <div class="mb-4">
                        <label for="class-filter" class="block text-sm font-medium text-gray-700">Pilih Kelas:</label>
                        <select id="class-filter" class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            ${classOptions}
                        </select>
                    </div>
                    <div id="attendance-content" class="bg-white p-6 rounded-lg shadow"></div>
                `;

                const classFilter = document.getElementById('class-filter');
                classFilter.addEventListener('change', (e) => {
                    renderTeacherAttendance(today, e.target.value);
                });
                
                renderTeacherAttendance(today, currentUser.kelasWali[0]);

            } else {
                renderParentAttendance(today);
            }
        }

        function renderTeacherAttendance(date, className) {
            const contentDiv = document.getElementById('attendance-content');
            if (!contentDiv) return;
            contentDiv.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            
            const attendanceRef = doc(db, "artifacts", appId, "public", "data", "attendance", date);
            const studentsQuery = query(collection(db, "artifacts", appId, "public", "data", "students"), where("kelas", "==", className));

            const unsub = onSnapshot(studentsQuery, async (studentsSnapshot) => {
                const attendanceSnap = await getDoc(attendanceRef);
                const attendanceData = attendanceSnap.exists() ? attendanceSnap.data() : {};
                
                let html = '<table class="w-full"><thead><tr class="text-left"><th class="p-3">Nama Siswa</th><th class="p-3">Status</th></tr></thead><tbody>';
                if (studentsSnapshot.empty) {
                    html += '<tr><td colspan="2" class="text-center p-4 text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                }
                studentsSnapshot.forEach(studentDoc => {
                    const student = studentDoc.data();
                    const studentId = studentDoc.id;
                    const status = attendanceData[studentId] || 'Belum Diabsen';
                    html += `
                        <tr class="border-t">
                            <td class="p-3">${student.nama}</td>
                            <td class="p-3">
                                <select data-studentid="${studentId}" data-studentname="${student.nama}" class="attendance-select rounded-md border-gray-300">
                                    <option value="Hadir" ${status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                                    <option value="Izin" ${status === 'Izin' ? 'selected' : ''}>Izin</option>
                                    <option value="Sakit" ${status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                                    <option value="Alfa" ${status === 'Alfa' ? 'selected' : ''}>Alfa</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                contentDiv.innerHTML = html;

                document.querySelectorAll('.attendance-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const studentId = e.target.dataset.studentid;
                        const studentName = e.target.dataset.studentname;
                        const newStatus = e.target.value;
                        const attendanceRef = doc(db, "artifacts", appId, "public", "data", "attendance", date);
                        
                        await setDoc(attendanceRef, { [studentId]: newStatus }, { merge: true });
                        
                        const notification = document.createElement('div');
                        notification.textContent = `Absensi ${studentName} diperbarui.`;
                        notification.className = 'fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 2000);
                    });
                });
            });
            unsubscribeListeners.push(unsub);
        }

        function renderParentAttendance(date) {
            const contentDiv = document.getElementById('attendance-view');
            const childId = currentUser.childId;
            
            const unsubStudent = onSnapshot(doc(db, "artifacts", appId, "public", "data", "students", childId), (studentDoc) => {
                if (!studentDoc.exists()) return;
                const studentData = studentDoc.data();
                const unsubAttendance = onSnapshot(doc(db, "artifacts", appId, "public", "data", "attendance", date), (attendanceSnap) => {
                    const attendanceData = attendanceSnap.exists() ? attendanceSnap.data() : {};
                    const status = attendanceData[childId] || 'Belum ada data';
                    
                    let statusClass = '';
                    switch(status) {
                        case 'Hadir': statusClass = 'bg-green-100 text-green-800'; break;
                        case 'Izin': statusClass = 'bg-blue-100 text-blue-800'; break;
                        case 'Sakit': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                        case 'Alfa': statusClass = 'bg-red-100 text-red-800'; break;
                        default: statusClass = 'bg-gray-100 text-gray-800';
                    }

                    contentDiv.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow">
                            <p class="text-lg">Status kehadiran untuk <strong>${studentData.nama}</strong>:</p>
                            <div class="mt-4 text-2xl font-bold p-4 rounded-lg text-center ${statusClass}">
                                ${status}
                            </div>
                        </div>
                    `;
                });
                unsubscribeListeners.push(unsubAttendance);
            });
            unsubscribeListeners.push(unsubStudent);
        }

        function renderSiswa(container) {
             container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Siswa</h1>
                <div id="student-list-container" class="bg-white p-6 rounded-lg shadow"></div>
            `;
            if(currentUser.role === 'teacher') {
                renderAllStudents();
            } else {
                renderChildData();
            }
        }

        function renderAllStudents() {
            const listContainer = document.getElementById('student-list-container');
            const q = query(collection(db, "artifacts", appId, "public", "data", "students"));
            const unsub = onSnapshot(q, (querySnapshot) => {
                let html = '<table class="w-full"><thead><tr class="text-left"><th class="p-3">Nama</th><th class="p-3">Kelas</th><th class="p-3">Orang Tua</th></tr></thead><tbody>';
                querySnapshot.forEach(doc => {
                    const student = doc.data();
                    html += `<tr class="border-t hover:bg-gray-50"><td class="p-3">${student.nama}</td><td class="p-3">${student.kelas}</td><td class="p-3">${student.ortu}</td></tr>`;
                });
                html += '</tbody></table>';
                listContainer.innerHTML = html;
            });
            unsubscribeListeners.push(unsub);
        }

        function renderChildData() {
            const listContainer = document.getElementById('student-list-container');
            const childId = currentUser.childId;
            const unsub = onSnapshot(doc(db, "artifacts", appId, "public", "data", "students", childId), (doc) => {
                if (!doc.exists()) return;
                const student = doc.data();
                listContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-4">Profil Anak Anda</h2>
                    <div class="space-y-3">
                        <p><strong>Nama:</strong> ${student.nama}</p>
                        <p><strong>Kelas:</strong> ${student.kelas}</p>
                        <p><strong>Wali Murid:</strong> ${student.ortu}</p>
                    </div>
                `;
            });
            unsubscribeListeners.push(unsub);
        }

        // --- Fungsi Helper & Event Listener ---
        function updateActiveNav(view) {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${view}`).classList.add('active');
        }

        async function switchUser(role) {
            currentUser = (role === 'teacher') ? teacherUser : parentUser;
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <p class="font-semibold">${currentUser.nama}</p>
                <p class="text-sm text-blue-300 capitalize">${currentUser.role}</p>
            `;
            
            const teacherBtn = document.getElementById('switch-to-teacher');
            const parentBtn = document.getElementById('switch-to-parent');
            if (role === 'teacher') {
                teacherBtn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-blue-900', 'ring-white');
                parentBtn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-blue-900', 'ring-white');
            } else {
                parentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-blue-900', 'ring-white');
                teacherBtn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-blue-900', 'ring-white');
            }

            renderContent(currentView);
        }
        
        // --- Modal Logic ---
        const announcementModal = document.getElementById('announcement-modal');
        const announcementBackdrop = document.getElementById('announcement-modal-backdrop');
        const profileModal = document.getElementById('profile-modal');
        const profileBackdrop = document.getElementById('profile-modal-backdrop');

        function openAnnouncementModal() {
            announcementModal.style.display = 'block';
            announcementBackdrop.style.display = 'block';
        }
        function closeAnnouncementModal() {
            document.getElementById('announcement-form').reset();
            announcementModal.style.display = 'none';
            announcementBackdrop.style.display = 'none';
        }
        
        async function openProfileModal() {
            const profileRef = doc(db, "artifacts", appId, "public", "data", "school", "profile");
            const profileSnap = await getDoc(profileRef);
            const data = profileSnap.data();
            
            document.getElementById('profile-name').value = data.nama;
            document.getElementById('profile-address').value = data.alamat;
            document.getElementById('profile-vision').value = data.visi;
            document.getElementById('profile-mission').value = data.misi;

            profileModal.style.display = 'block';
            profileBackdrop.style.display = 'block';
        }
        function closeProfileModal() {
            document.getElementById('profile-form').reset();
            profileModal.style.display = 'none';
            profileBackdrop.style.display = 'none';
        }

        // --- Event Listeners ---
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                currentView = item.id.replace('nav-', '');
                renderContent(currentView);
            });
        });

        document.getElementById('switch-to-teacher').addEventListener('click', () => switchUser('teacher'));
        document.getElementById('switch-to-parent').addEventListener('click', () => switchUser('parent'));
        
        // Announcement Modal Listeners
        document.getElementById('save-announcement').addEventListener('click', async () => {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;
            if (title && content) {
                await addDoc(collection(db, "artifacts", appId, "public", "data", "announcements"), {
                    judul: title,
                    isi: content,
                    tanggal: new Date()
                });
                closeAnnouncementModal();
            }
        });
        document.getElementById('cancel-announcement').addEventListener('click', closeAnnouncementModal);
        announcementBackdrop.addEventListener('click', closeAnnouncementModal);
        
        // Profile Modal Listeners
        document.getElementById('save-profile').addEventListener('click', async () => {
             const updatedProfile = {
                nama: document.getElementById('profile-name').value,
                alamat: document.getElementById('profile-address').value,
                visi: document.getElementById('profile-vision').value,
                misi: document.getElementById('profile-mission').value
            };
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "school", "profile"), updatedProfile);
            closeProfileModal();
        });
        document.getElementById('cancel-profile').addEventListener('click', closeProfileModal);
        profileBackdrop.addEventListener('click', closeProfileModal);


        // Inisialisasi aplikasi saat DOM siap
        document.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script>
</body>

</html>
